<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ByteChain Search Results</title>
  <style>
    body {
      background: #0f0f13;
      color: #f5f5f5;
      font-family: sans-serif;
      padding: 30px;
    }
    .result {
      background: #1c1c24;
      border: 1px solid #333;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    .label {
      font-weight: bold;
      color: #8df;
    }
    a {
      color: #5af;
    }
  </style>
</head>
<body>
  <h2>Search Results</h2>
  <div id="results">Loading...</div>

  <script>
    const API = 'http://localhost:3002';
    const params = new URLSearchParams(location.search);
    const query = params.get('q')?.toLowerCase();
    const resultsDiv = document.getElementById('results');

    if (!query) {
      resultsDiv.textContent = 'No search query provided.';
    } else {
      fetch(`${API}/chain`)
        .then(res => res.json())
        .then(chain => {
          const txMatches = [];
          let blockMatch = null;
          let txMatch = null;

          for (const block of chain) {
            if (block.block_header.block_hash.toLowerCase() === query) {
              blockMatch = block;
            }
            for (const tx of block.transactions) {
              if (tx.tx_id?.toLowerCase() === query) {
                txMatch = { block, tx };
              }
              if (tx.sender?.toLowerCase() === query || tx.recipient?.toLowerCase() === query) {
                txMatches.push({ block, tx });
              }
            }
          }

          resultsDiv.innerHTML = '';

          if (blockMatch) {
            resultsDiv.innerHTML += `
              <div class="result">
                <div><strong>Height:</strong> ${blockMatch.block_header.block_height}</div>
                <div><strong>Timestamp:</strong> ${new Date(blockMatch.block_header.timestamp).toLocaleString()}</div>
                <div><strong>Nonce:</strong> ${blockMatch.block_header.nonce}</div>
                <div><strong>Hash:</strong> <code>${blockMatch.block_header.block_hash}</code></div>
                <div><strong>Previous Hash:</strong> <code>${blockMatch.block_header.prev_block_hash}</code></div>
                <div><strong>Transaction count:</strong> ${blockMatch.transactions.length}</div>
              </div>`;
          }

          if (txMatch) {
            resultsDiv.innerHTML += `
              <div class="result">
                <div class="label">Transaction Match</div>
                <div>amount: ${txMatch.tx.amount}</div>
                <div>sender: ${txMatch.tx.sender}</div>
                <div>recipient: ${txMatch.tx.recipient}</div>
                <div>transaction id.: ${txMatch.tx.tx_id}</div>
              </div>`;
          }

          for (let tx in txMatches) {
            resultsDiv.innerHTML += `
              <div class="result">
                <div class="label">Address History (${txMatches.length} txns)</div>
                ${txMatches.map(({ tx }) => `
                  <div>
                    amount: ${tx.amount}
                    sender: ${tx.sender}<br/>
                    recipient: ${tx.recipient}<br/>
                    transaction id.: ${tx.tx_id}<br/>
                  </div>
                `)}
              </div>`;
          }

          if (!blockMatch && !txMatch && txMatches.length === 0) {
            resultsDiv.innerHTML = `<div>No results found for <code>${query}</code>.</div>`;
          }
        });
    }
  </script>
</body>
</html>
